#!/bin/bash
pgm="${0%%/}"
version="$pgm version 1.1"
index_file_name='LINKS.org'
usage="$pgm directory_path[/.git]..."
help1='Index local path links in .org files under given directories.'
help2="Index files will be named $index_file_name"
err_out() { 2>/dev/null echo "$*"; }
err_msg() { err_out "$pgm error: $*"; }
err_exit() { x="$1"; shift; err_msg "$*"; exit "$x"; }
info_exit() { [ $# -eq 0 ] || echo "$*"; exit 2; }

type -p rg >/dev/null || err_exit 3 "requires rg (ripgrep) program"

dir_path() {
   local d="${1%/}"             # how can we remove multiple trailing /'s??
   printf "%s" "${d1%/.git}"
}

for d; do
    case "$d" in
        --version) info_exit "$version" ;;
        --usage) info_exit "$usage" ;;
        --help) echo "$version"; echo "$help1"; echo "$help2"
                info_exit ;;
    esac
    [ -d "$d" ] || err_exit 4 "expected directory $d"
done

for d; do
  d="${d%/}"
  d="${d%/.git}"
  if ! cd "$d"; then
    2>/dev/null echo "$pgm: can't cd to $d"
  else {
    cat <<EOF
#+TITLE: Directory Tree $d
#+SUBTITLE: OrgMode File Embedded Links

* File Paths and Links

  This file is generated by the =make-org-links= script.
  Do /NOT/ manually edit this file!

EOF
  rg '(\[\[[a-z]+:[^[:space:]\]]+\]\[[^\[\]]+\]\])' \
    --heading \
    --with-filename \
    -g '*.org' \
    -r '!@!
- $1
!@!' |
sed -e '/^!@!/d' -e '/!@!$/d' -e 's/^\([^-] \)/** \1/'
} > "$index_file_name"
fi
done

#!/bin/bash
pgm="${0##*/}"
version="$pgm version 2.1"
index_file_name='LINKS.org'
usage="Usage: $pgm DIRECTORY_PATH[/.git]..."
help=(
'Index local path links in .org files under given directories'
"$index_file_name will be overwritten with new links!"
"$index_file_name will be removed if no links are found!"
"Example: $pgm ~/My-Project/"
"Example: $pgm ~/Projects/*/.git"
"Example: $pgm \$(find ~/Projects/ -name .git)"
)
err_out() {
    level="$1"; shift
    >&2 printf '%s %s: %s\n' "$pgm" "$level" "$*"
}
err_exit() { x="$1"; shift; err_out error "$*"; exit "$x"; }
info_exit() { [ $# -eq 0 ] || printf '%s\n' "$*"; exit 2; }

type -p rg >/dev/null || err_exit 3 "requires rg (ripgrep) program"

# strip off trailing .git or slashes
# root directory paths will not be trimmed
trim_path() {
    expr "$1" : '\(.*[^/]\)//*.git/*$' \| \
         "$1" : '\(.*[^/]\)/*$' \| \
         "$1" : '\(.*\)'
}

for d; do
    case "$d" in
        --version) info_exit "$version" ;;
        --usage) info_exit "$usage" ;;
        --help) printf '%s\n' "$usage"
                for x in "${help[@]}"; do
                    printf '%s\n' "$x"
                done
                info_exit "$version";;
    esac
    [ -d "$d" ] || err_exit 4 "expected directory $d"
done

for d; do
  dd="`trim_path "$d"`"
  if ! cd "$dd"; then
    err_out warning "can't cd to $dd"
  else
  rg '(\[\[[a-z]+:[^[:space:]\]]+\]\[[^\[\]]+\]\])' \
    --heading \
    --with-filename \
    -g !"$index_file_name" \
    -g '*.org' \
    -g !"$index_file_name" \
    -r '!@!
- $1
!@!' |
sed -e '/^!@!/d' -e '/!@!$/d' -e 's/^\([^- ]\)/** \1/' | {
  msg="#+TITLE: Directory Tree $dd
#+SUBTITLE: OrgMode File Embedded Links

* File Paths and Links

  This file is generated by the =make-org-links= script.
  Do /NOT/ manually edit this file!

"
  # create or truncate as empty file
  > "$index_file_name"
  while read line; do
      printf '%s' "$msg"
      printf '%s\n' "$line"
      msg=''
  done > "$index_file_name"
  # remove file if still empty
  [ -s "$index_file_name" ] || rm "$index_file_name"
}; fi; done
